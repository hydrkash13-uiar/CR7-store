<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOMA - Ù…ØªØ¬Ø±</title>
  <style>
    :root{
      --bg:#0b0b0d; --gold:#d4af37; --muted:#bdbdbd; --card:#0f1113;
      --accent:#1f2937; --danger:#e14b4b;
    }
    html,body{height:100%;margin:0;font-family:Tahoma, Arial, "Noto Naskh Arabic", sans-serif;direction:rtl}
    body{background:linear-gradient(180deg,#050505 0%, #0b0b0d 100%); color:#fff; padding:16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;color:var(--gold)}
    .container{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media (max-width:900px){ .container{grid-template-columns:1fr} .sidebar{order:2} }
    .card{background:linear-gradient(180deg,var(--card),#0b0b0d); padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
    nav{display:flex;gap:6px;flex-wrap:wrap}
    button, .btn{background:var(--gold);border:none;color:#000;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid #2b2b2b;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:14px}
    .small{font-size:13px;color:var(--muted)}
    input,select{padding:8px;border-radius:8px;border:1px solid #222;background:#060606;color:#fff}
    .sidebar{position:sticky;top:16px;height:fit-content;display:flex;flex-direction:column;gap:12px}
    .balance{font-size:22px;color:var(--gold);font-weight:700}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .notif-list{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .order{border-left:3px solid var(--gold);padding:8px;border-radius:6px;background:rgba(255,255,255,0.015)}
    footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}
    .admin-panel{display:grid;gap:8px}
    .danger{background:var(--danger);color:#fff}
  </style>
</head>
<body>

<header>
  <div>
    <h1>SOMA â€” Ù…ØªØ¬Ø± Ø§Ù„Ø´Ø­Ù†</h1>
    <div class="small muted">Ù†Ø¸Ø§Ù… Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªÙ„Ø¬Ø±Ø§Ù…</div>
  </div>

  <nav>
    <button id="open-login" class="btn">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
    <button id="open-admin" class="btn-ghost">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</button>
  </nav>
</header>

<div class="container">

  <!-- Main column -->
  <main>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª -->
    <section class="card" style="margin-bottom:12px">
      <div class="section-title">
        <strong>ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</strong>
        <small class="muted">Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ ÙˆØ§Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</small>
      </div>
      <div id="apps" class="list"></div>
    </section>

    <!-- Ø§Ù„Ø§Ø±ØµØ¯Ø© -->
    <section class="card" style="margin-bottom:12px">
      <div class="section-title">
        <strong>Ø§Ù„Ø£Ø±ØµØ¯Ø© / Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ø­Ù†</strong>
        <small class="muted">Ø£Ø³Ø¹Ø§Ø± Ø¬Ø§Ù‡Ø²Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</small>
      </div>
      <div id="credits" class="list"></div>
    </section>

    <!-- Ø§Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…) -->
    <section class="card" style="margin-bottom:12px">
      <div class="section-title"><strong>Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ù„Ø­Ø³Ø§Ø¨Ùƒ</strong></div>
      <form id="add-balance-form" onsubmit="return false;" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="add-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©" inputmode="numeric" />
        <select id="payment-method">
          <option value="manual">Ø¯ÙØ¹ ÙŠØ¯ÙˆÙŠ/ØªØ­ÙˆÙŠÙ„</option>
          <option value="fake">Ø¯ÙØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)</option>
        </select>
        <button class="btn" id="submit-add">Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯</button>
      </form>
      <div class="small muted" style="margin-top:8px">Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠÙØ³Ø¬Ù„ ÙƒØ·Ù„Ø¨ ÙˆØ§Ù„Ø¯ÙØ¹ ÙŠØ±Ø³Ù„ Ù„Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±.</div>
    </section>

    <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <section class="card">
      <div class="section-title">
        <strong>Ø§Ù„Ø¯ÙØ¹Ø§Øª Ùˆ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</strong>
        <div>
          <button id="refresh-orders" class="btn-ghost">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div id="orders" class="list"></div>
    </section>

  </main>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="card">
      <div class="small muted">Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div class="balance" id="user-balance">0</div>
      <div class="small muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-user">Ø²Ø§Ø¦Ø±</span></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="go-cart" class="btn">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</button>
        <button id="logout" class="btn-ghost">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</strong></div>
      <div class="notif-list" id="notifications"></div>
    </div>

    <div class="card">
      <div class="section-title"><strong>Ø§Ù„Ø¯ÙØ§Ø¹Ø§Øª</strong><small class="muted">Ù…ÙŠØ²Ø§Øª Ø£Ù…Ø§Ù† Ø¨Ø³ÙŠØ·Ø©</small></div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label><input type="checkbox" id="defense-login" /> Ø­Ù…Ø§ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø«Ø§Ù„)</label>
        <label><input type="checkbox" id="defense-ip" /> Ø­Ø¸Ø± IP Ù…Ø´Ø¨ÙˆÙ‡ (Ù…Ø«Ø§Ù„)</label>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><strong>Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)</strong></div>
      <div class="small muted">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù€ chat_id ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <input id="tg-token" placeholder="BOT_TOKEN (Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§)" />
        <input id="tg-chat" placeholder="CHAT_ID (Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Øª Ø£Ùˆ Ø§Ù„Ù‚Ù†Ø§Ø©)" />
        <button id="save-tg" class="btn">Ø­ÙØ¸</button>
      </div>
    </div>

  </aside>
</div>

<footer class="muted card">SOMA â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ø³ÙŠØ·Ø©. Ù„ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±Ù…Ø¬ÙŠØ§ØªÙŠ Ø£Ù†Ø§ Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.</footer>

<!-- Modal: Login / Register / Cart / Admin -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,.6);z-index:999">
  <div class="card" style="width:100%;max-width:720px;direction:rtl">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong id="modal-title">ØªØ³Ø¬ÙŠÙ„</strong>
      <button id="close-modal" class="btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="modal-body"></div>
  </div>
</div>

<script>
/* ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ========== */
const SAMPLE_APPS = [
  {id:'wh',name:'ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙˆØª',price:5,desc:'Ø­Ø²Ù…Ø© ØªØ´ØºÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨ - ØªØ±Ø®ÙŠØµ Ø´Ù‡Ø±ÙŠ'},
  {id:'tg',name:'ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨ÙˆØª',price:4,desc:'Ø­Ø²Ù…Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù… - ØªØ±Ø®ÙŠØµ Ø´Ù‡Ø±ÙŠ'},
  {id:'ig',name:'Ø§Ù†Ø³ØªØºØ±Ø§Ù… Ø£Ø¯ÙˆØ§Øª',price:6,desc:'Ø¨Ø§Ù‚Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù†Ø³ØªØºØ±Ø§Ù…'}
];
const SAMPLE_CREDITS = [
  {id:'c10',name:'Ø±ØµÙŠØ¯ 10',price:10},
  {id:'c25',name:'Ø±ØµÙŠØ¯ 25',price:25},
  {id:'c50',name:'Ø±ØµÙŠØ¯ 50',price:50}
];

/* ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ ========== */
const state = {
  user: null, // {id, name, balance}
  cart: [],
  orders: [],
  notifications: [],
  tg: {token:'', chat:''}
};

function saveState(){
  localStorage.soma_state = JSON.stringify({users:db.users, orders:state.orders, tg:state.tg});
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.soma_state || '{}');
    state.orders = s.orders || [];
    state.tg = s.tg || {token:'', chat:''};
    if(s.users) db.users = s.users;
  }catch(e){}
}

/* ========== Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙŠ localStorage ========== */
const db = {
  users: {
    // Ù…Ø«Ø§Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ±: admin / pass: 1234
    admin: {id:'admin',name:'Ù…Ø¯ÙŠØ± SOMA',pass:'1234',balance:1000,isAdmin:true},
  }
};

/* ========== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶ ========== */
const appsEl = document.getElementById('apps');
const creditsEl = document.getElementById('credits');
const ordersEl = document.getElementById('orders');
const notificationsEl = document.getElementById('notifications');
const userBalanceEl = document.getElementById('user-balance');
const currentUserEl = document.getElementById('current-user');
const tgTokenInput = document.getElementById('tg-token');
const tgChatInput = document.getElementById('tg-chat');

function renderApps(){ appsEl.innerHTML=''; SAMPLE_APPS.forEach(a=>{
  const it = document.createElement('div'); it.className='item';
  it.innerHTML = `<div><strong>${a.name}</strong><div class="small muted">${a.desc}</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small muted">${a.price} USD</div>
      <button class="btn" onclick="addToCart('${a.id}','app')">Ø§Ø´ØªØ±ÙŠ</button>
    </div>`;
  appsEl.appendChild(it);
})}

function renderCredits(){ creditsEl.innerHTML=''; SAMPLE_CREDITS.forEach(c=>{
  const it = document.createElement('div'); it.className='item';
  it.innerHTML = `<div><strong>${c.name}</strong></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small muted">${c.price} USD</div>
      <button class="btn" onclick="addToCart('${c.id}','credit')">Ø§Ø´ØªØ±ÙŠ</button>
    </div>`;
  creditsEl.appendChild(it);
})}

function renderOrders(){
  ordersEl.innerHTML = '';
  if(state.orders.length===0){ ordersEl.innerHTML = '<div class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>'; return }
  state.orders.slice().reverse().forEach(o=>{
    const it = document.createElement('div'); it.className='order';
    it.innerHTML = `<div style="display:flex;justify-content:space-between">
      <div><strong>Ø·Ù„Ø¨ #${o.id}</strong><div class="small muted">Ù…Ù†: ${o.user}</div></div>
      <div class="small muted">${o.total} USD</div>
    </div>
    <div class="small muted" style="margin-top:6px">${o.status} â€” ${o.note||''}</div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" onclick="confirmOrder('${o.id}')">ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù…</button>
      <button class="btn-ghost" onclick="cancelOrder('${o.id}')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>`;
    ordersEl.appendChild(it);
  })
}

function renderNotifications(){
  notificationsEl.innerHTML='';
  if(state.notifications.length===0) notificationsEl.innerHTML='<div class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
  state.notifications.slice().reverse().forEach(n=>{
    const d = document.createElement('div'); d.className='small muted'; d.textContent = `${n.time} â€” ${n.text}`;
    notificationsEl.appendChild(d);
  })
}

function updateUserUI(){
  const u = state.user;
  currentUserEl.textContent = u ? u.name : 'Ø²Ø§Ø¦Ø±';
  userBalanceEl.textContent = u ? u.balance : '0';
}

/* ========== Ø³Ù„ÙˆÙƒ Ø§Ù„Ø³Ù„Ø© / Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¯ÙØ¹ ========== */
function addToCart(id,type){
  const item = (type==='app' ? SAMPLE_APPS.find(a=>a.id===id) : SAMPLE_CREDITS.find(c=>c.id===id));
  if(!item){ alert('Ø®Ø·Ø£: Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  state.cart.push({id:item.id, name:item.name || item.title, price:item.price, type});
  openCartModal();
}

function openCartModal(){
  const body = document.getElementById('modal-body');
  document.getElementById('modal-title').textContent = 'Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
  body.innerHTML = '';
  if(state.cart.length===0){ body.innerHTML = '<div class="small muted">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>'; showModal(); return; }
  const list = document.createElement('div'); list.className='list';
  let total = 0;
  state.cart.forEach((c,idx)=>{
    total += c.price;
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div><strong>${c.name}</strong><div class="small muted">${c.type}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="small muted">${c.price} USD</div>
        <button class="btn-ghost" onclick="removeFromCart(${idx})">Ø­Ø°Ù</button>
      </div>`;
    list.appendChild(it);
  });
  body.appendChild(list);
  const footer = document.createElement('div'); footer.style.marginTop='12px';
  footer.innerHTML = `<div class="small muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${total} USD</strong></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="checkout()">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
      <button class="btn-ghost" onclick="clearCart()">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
    </div>`;
  body.appendChild(footer);
  showModal();
}

function removeFromCart(idx){ state.cart.splice(idx,1); openCartModal(); }
function clearCart(){ state.cart = []; openCartModal(); }

function checkout(){
  if(!state.user){ alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ù…Ù„ Ø·Ù„Ø¨'); return; }
  const total = state.cart.reduce((s,i)=>s+i.price,0);
  // Ù†Ù†Ø´Ø¦ Ø·Ù„Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
  const id = 'ORD'+Date.now();
  const order = {id, user:state.user.id, userName:state.user.name, items:state.cart.slice(), total, status:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹', time: new Date().toLocaleString(), note:''};
  state.orders.push(order);
  addNotification(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ${id} Ø¨Ù‚ÙŠÙ…Ø© ${total} USD Ù…Ù† ${state.user.name}`);
  // Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (Ø¥Ù† ÙˆÙØ¬Ø¯)
  sendToTelegram(`ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\n#${id}\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${state.user.name}\nØ§Ù„Ù…Ø¨Ù„Øº: ${total} USD\nØ§Ù„ÙˆÙ‚Øª: ${order.time}`);
  state.cart = [];
  saveState();
  renderOrders(); renderNotifications(); updateUserUI();
  alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (Ø¥Ù† ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª).');
  closeModal();
}

/* ========== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
function confirmOrder(id){
  const o = state.orders.find(x=>x.id===id);
  if(!o) return;
  o.status = 'Ù…Ø¤ÙƒØ¯ - ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…';
  addNotification(`ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ${id}`);
  sendToTelegram(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ${id} Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.`);
  saveState(); renderOrders(); renderNotifications();
}
function cancelOrder(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
  const o = state.orders.find(x=>x.id===id);
  if(!o) return;
  o.status = 'Ù…Ù„ØºÙ‰';
  addNotification(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${id}`);
  sendToTelegram(`âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${id}.`);
  saveState(); renderOrders(); renderNotifications();
}

/* ========== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ========== */
function addNotification(text){
  state.notifications.push({time:new Date().toLocaleString(), text});
  renderNotifications();
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ùˆ Ø¯Ø®ÙˆÙ„ (Ø¨Ø³ÙŠØ·) ========== */
function openLoginModal(){
  document.getElementById('modal-title').textContent='ØªØ³Ø¬ÙŠÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
  const body = document.getElementById('modal-body');
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="reg-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø«Ø§Ù„: Ali)" />
      <input id="reg-id" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø¹Ø±Ù‘Ù) - Ù…Ø«Ø§Ù„: ali01" />
      <input id="reg-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
      <div style="display:flex;gap:8px">
        <button class="btn" id="do-register">ØªØ³Ø¬ÙŠÙ„</button>
        <button class="btn-ghost" id="do-login">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div class="small muted">Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ø³ØªØ®Ø¯Ù…: admin / 1234</div>
    </div>`;
  showModal();

  document.getElementById('do-register').onclick = ()=>{
    const name = document.getElementById('reg-name').value.trim();
    const id = document.getElementById('reg-id').value.trim();
    const pass = document.getElementById('reg-pass').value.trim();
    if(!id||!pass||!name){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
    if(db.users[id]){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯'); return; }
    db.users[id] = {id,name,pass,balance:0,isAdmin:false};
    state.user = db.users[id];
    saveState();
    addNotification(`Ø§Ù†Ø´Ø£ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯: ${name}`);
    updateUserUI(); renderNotifications(); closeModal();
  }
  document.getElementById('do-login').onclick = ()=>{
    const id = document.getElementById('reg-id').value.trim();
    const pass = document.getElementById('reg-pass').value.trim();
    if(!id||!pass){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
    const u = db.users[id];
    if(!u || u.pass !== pass){ alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
    state.user = u;
    addNotification(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${u.name}`);
    updateUserUI(); renderNotifications(); saveState(); closeModal();
  }
}

/* ========== Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ========== */
function openAdminModal(){
  document.getElementById('modal-title').textContent='Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±';
  const body = document.getElementById('modal-body');
  body.innerHTML = `
    <div class="admin-panel">
      <div class="small muted">Ø£Ø¶Ù/Ø­Ø°Ù Ø±ØµÙŠØ¯ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
      <div style="display:flex;gap:8px">
        <input id="adm-userid" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" /><input id="adm-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (+/-)" />
        <button class="btn" id="adm-apply">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="small muted">Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div style="display:flex;gap:8px">
        <input id="adm-orderid" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ORD...)" />
        <button class="btn" id="adm-mark-ready">ÙˆØ¶Ø¹ ÙƒÙ…Ø¤ÙƒØ¯</button>
      </div>
      <div class="small muted">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„ØªÙ„Ø¬Ø±Ø§Ù…</div>
      <textarea id="adm-msg" rows="3" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"></textarea>
      <div style="display:flex;gap:8px">
        <button class="btn" id="adm-send-tg">Ø£Ø±Ø³Ù„ Ù„Ù„ØªÙ„Ø¬Ø±Ø§Ù…</button>
        <button class="btn danger" id="adm-clear">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ø±ÙŠØ¨ÙŠ)</button>
      </div>
    </div>
  `;
  showModal();

  document.getElementById('adm-apply').onclick = ()=>{
    const id = document.getElementById('adm-userid').value.trim();
    const amount = parseFloat(document.getElementById('adm-amount').value || 0);
    if(!id || !db.users[id]){ alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    db.users[id].balance = (db.users[id].balance||0) + amount;
    addNotification(`ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ ${id} Ø¨Ù…Ù‚Ø¯Ø§Ø± ${amount}`);
    saveState(); updateUserUI(); renderNotifications();
  };

  document.getElementById('adm-mark-ready').onclick = ()=>{
    const id = document.getElementById('adm-orderid').value.trim();
    const o = state.orders.find(x=>x.id===id);
    if(!o){ alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    o.status = 'Ù…Ø¤ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±';
    addNotification(`Ø§Ù„Ø·Ù„Ø¨ ${id} ØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±`);
    saveState(); renderOrders(); renderNotifications();
    sendToTelegram(`ğŸ“£ Ø¥Ø´Ø¹Ø§Ø±: Ø§Ù„Ø·Ù„Ø¨ ${id} ØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±`);
  };

  document.getElementById('adm-send-tg').onclick = ()=>{
    const m = document.getElementById('adm-msg').value.trim();
    if(!m) return alert('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©');
    sendToTelegram(`ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±:\n${m}`);
    alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ùˆ chat_id ÙˆØ¶Ø¹Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)');
  };

  document.getElementById('adm-clear').onclick = ()=>{
    if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ Ù‡Ø°Ø§ Ù„Ù„Ø¥Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·.')) return;
    state.orders = [];
    saveState(); renderOrders(); addNotification('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ø±ÙŠØ¨ÙŠ)');
    renderNotifications(); alert('ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
  };
}

/* ========== Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙ„Ø¬Ø±Ø§Ù… ========== */
function sendToTelegram(text){
  // ÙŠÙ‚Ø±Ø£ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù€ chat Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const token = state.tg.token || tgTokenInput.value.trim();
  const chat = state.tg.chat || tgChatInput.value.trim();
  if(!token || !chat){
    console.log('Telegram not configured. Message:', text);
    return;
  }
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ ÙŠØ³ØªØ®Ø¯Ù… fetch Ø¥Ù„Ù‰ API Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…. 
  // ÙŠØ¬Ø¨ Ø£Ù† ØªØ¯ÙŠØ± Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ø³Ø±ÙŠØ©ØŒ ÙˆØªØ®Ø²Ù†Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø£Ù…Ø§Ù†Ù‹Ø§ Ø£Ø¹Ù„Ù‰.
  fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({chat_id:chat, text, parse_mode:'HTML'})
  }).then(r=>r.json()).then(res=>{
    if(res.ok) addNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…');
    else addNotification('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†/chat_id)');
  }).catch(err=>{
    console.error(err); addNotification('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙ„Ø¬Ø±Ø§Ù…');
  });
}

/* ========== Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… ========== */
document.getElementById('save-tg').onclick = ()=>{
  state.tg.token = tgTokenInput.value.trim();
  state.tg.chat = tgChatInput.value.trim();
  saveState();
  addNotification('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (Ù…Ø­Ù„ÙŠØ§Ù‹)');
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§. ØªØ°ÙƒØ±: Ù„Ø§ ØªØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…ÙƒØ§Ù† Ø¹Ø§Ù….');
}

/* ========== Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø·Ù„Ø¨) ========== */
document.getElementById('submit-add').onclick = ()=>{
  if(!state.user){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const amt = parseFloat(document.getElementById('add-amount').value||0);
  const method = document.getElementById('payment-method').value;
  if(!amt || amt<=0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹'); return; }
  const id = 'TOPUP'+Date.now();
  const order = {id, user:state.user.id, userName:state.user.name, items:[{name:'Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯',
